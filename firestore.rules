rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== USERS ==========
    match /users/{userId} {
      // Ai đã đăng nhập thì đọc được thông tin profile
      allow read: if request.auth != null;

      // Chỉ cho phép user tự tạo/sửa hồ sơ của mình
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if request.auth.uid == userId;
    }

    // ========== FRIENDSHIPS ==========
    match /friendships/{fid} {
  allow read: if request.auth != null 
              && request.auth.uid in resource.data.participants;
  allow create: if request.auth != null 
                && request.auth.uid in request.resource.data.participants;
  allow update: if request.auth != null 
                && request.auth.uid in resource.data.participants;
  // Cho phép cả sender và receiver được xoá
  allow delete: if request.auth != null 
                && request.auth.uid in resource.data.participants;
}

    // ========== CHATS ==========
    match /chats/{chatId} {
      // Chỉ participants được phép đọc chat
      allow read: if request.auth != null
        && request.auth.uid in resource.data.participants;

      // Tạo chat: chỉ cho khi 2 user đã là bạn bè
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.participants
        && isFriend(request.resource.data.participants);

      // Cập nhật chat (ví dụ lastMessage, updatedAt)
      allow update: if request.auth != null
        && request.auth.uid in resource.data.participants;

      // Không cho xoá chat
      allow delete: if false;

      // ----- MESSAGES -----
      match /messages/{messageId} {
        // Chỉ participants được phép đọc
        allow read: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        // Chỉ cho phép gửi tin nhắn khi là bạn bè
        allow create: if request.auth != null
          && request.auth.uid == request.resource.data.senderId
          && isFriend(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);

        // Không cho update/delete tin nhắn
        allow update, delete: if false;
      }
    }

    // ========== SUPPORT FUNCTION ==========
    function isFriend(participants) {
      let friendshipId = participants[0] < participants[1]
        ? participants[0] + "_" + participants[1]
        : participants[1] + "_" + participants[0];

      return exists(/databases/$(database)/documents/friendships/$(friendshipId))
        && get(/databases/$(database)/documents/friendships/$(friendshipId)).data.status == "accepted";
    }
  }
}
